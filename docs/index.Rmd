---
title: "Assessment"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

library(tidyverse)
library(lubridate)
library(scales)
library(knitr)
library(readxl)

theme_set(theme_minimal(base_size = 14))
```

# Introduction

In Scotland, epilepsy is a prevalent long-term neurological condition that can significantly affect day-to-day functioning. Unplanned hospital stays, loss of independence, and an increased risk of dying young are all associated with it (Public Health Scotland). Thus, ensuring equitable and efficient access to treatment is a crucial public health objective.

An older antiepileptic medication that is still commonly used is carbamazepine. It is used to treat certain types of nerve pain and is primarily prescribed in primary care to manage seizures.(Maan JS, Saadabadi A, and Duong TvH, 2023) National prescribing data offer a useful method of describing the amount of carbamazepine used and how it varies throughout Scotland because the majority of prescriptions are written in the community.

In this report, I describe recent carbamazepine prescriptions in NHS Scotland using data from Public Health Scotland Prescriptions in the Community. The primary questions are how prescribing volume varies between health boards and how the number of carbamazepine prescription items varies monthly. Additionally, I prepared the data for future research on inequality by linking it to the Scottish Index of Multiple Deprivation (Scottish Government SIMD 2020).  I anticipate that national volumes will remain relatively stable over time, with higher absolute counts in larger boards and a potential correlation between higher deprivation and higher prescribing volume.

# Data and methods

Public Health Scotland's open prescribing data, which includes all NHS prescriptions written in Scotland's communities, is used in the analysis. I created a single dataset by combining the board level files for the first seven months of the year. The payment month was used to create a date variable, and the data were limited to rows where the word "carbamazepine" appeared in the item description of the British National Formulary. This includes both branded and generic versions of the medication that are frequently used to treat epilepsy and associated disorders.

I totalled the gross ingredient cost and the number of paid items for each month throughout Scotland, then for each health board. One table with national totals by month and another with health board totals by month were created as a result. Tidyverse and Lubridate were used in R for all wrangling and summaries. The steps are written as a single pipeline that can be executed from a different script, supporting reproducibility and enabling automated data preparation prior to report knitting.

To prepare for the analysis of inequality The SIMD 200 data zone lookup was another tool I used. I determined the percentage of each health board's data zones that fell into the most and least deprived national quintiles. In order to add basic deprivation information to each board month record, this summary was linked to the carbamazepine prescribing table using the health board code. The primary purpose of the deprivation information in this report is to enhance the dataset so that further research on inequality can build upon it.

# Board level files for early 2025

```{r}
urls <- c(
  "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f02161c1-15f6-4d9f-8be5-01ba613d4303/download/hb_pitc2025_07.csv",
  "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9de908b3-9c28-4cc3-aa32-72350a0579d1/download/hb_pitc2025_01_06.csv"
)

presc_raw <- urls %>%
  map_dfr(readr::read_csv)

# Check column names
names(presc_raw)

# Add proper date from PaidDateMonth
presc <- presc_raw %>%
  mutate(
    date = ymd(paste0(PaidDateMonth, "01"))
  )

# Filter to carbamazepine items
carb_all <- presc %>%
  filter(str_detect(
    BNFItemDescription,
    regex("carbamazepine", ignore_case = TRUE)
  ))

# Scotland total by month
carb_scot_month <- carb_all %>%
  group_by(date) %>%
  summarise(
    total_items = sum(NumberOfPaidItems, na.rm = TRUE),
    total_cost  = sum(GrossIngredientCost, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(date)

# Board level by month using HBT as board code
carb_board_month <- carb_all %>%
  group_by(date, HBT) %>%
  summarise(
    total_items = sum(NumberOfPaidItems, na.rm = TRUE),
    total_cost  = sum(GrossIngredientCost, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
# Read SIMD from the CSV version of the data zone lookup

simd_path <- "data_raw/SIMD2020v2_datazone_lookup.csv"

if (file.exists(simd_path)) {

  simd_dz <- readr::read_csv(simd_path, show_col_types = FALSE)

  # Health board level SIMD and population summary
  simd_board <- simd_dz %>%
    dplyr::group_by(HBcode, HBname) %>%
    dplyr::summarise(
      n_datazones = dplyr::n(),
      prop_q1_most_deprived  = mean(SIMD2020v2_Quintile == 1, na.rm = TRUE),
      prop_q5_least_deprived = mean(SIMD2020v2_Quintile == 5, na.rm = TRUE),
      board_population       = sum(Population, na.rm = TRUE),
      .groups = "drop"
    )

  # Join SIMD summary to prescribing using board code
  carb_board_month_simd <- carb_board_month %>%
    dplyr::left_join(simd_board, by = c("HBT" = "HBcode"))

} else {
  carb_board_month_simd <- NULL
}
```

# Results

## Scotland level prescribing

```{r}
# Add a reference line at the mean monthly volume to help interpret variation
mean_scot_items <- mean(carb_scot_month$total_items, na.rm = TRUE)

ggplot(carb_scot_month, aes(x = date, y = total_items)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  geom_smooth(
    method = "loess",
    se = FALSE,
    linewidth = 0.7,
    linetype = "dashed"
  ) +
  geom_hline(
    yintercept = mean_scot_items,
    linetype = "dotted"
  ) +
  scale_x_date(
    date_labels = "%b",
    breaks = unique(carb_scot_month$date)
  ) +
  scale_y_continuous(labels = label_comma()) +
  labs(
    title = "Monthly carbamazepine prescriptions in Scotland",
    subtitle = "Number of paid items in community prescribing 2025",
    x = "Month",
    y = "Number of prescription items"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Figure one shows the total number of carbamazepine items dispensed in the community in Scotland for each month in the first part of the year. Overall the national level is fairly stable, with values in a narrow band rather than a clear upward or downward trend. There is a dip at the start of the year, followed by a gradual rise towards mid year. This pattern is consistent with normal variation in prescribing for a medicine that is mainly used in long term treatment.

# Differences between health boards

```{r}
carb_board_summary <- carb_board_month %>%
  group_by(HBT) %>%
  mutate(
    mean_items = mean(total_items, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    HBT = forcats::fct_reorder(HBT, mean_items, .desc = TRUE)
  )

ggplot(carb_board_summary,
       aes(x = date, y = total_items, group = HBT)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 0.8) +
  scale_x_date(date_labels = "%b") +
  scale_y_continuous(labels = label_comma()) +
  labs(
    title = "Carbamazepine prescribing by NHS board",
    subtitle = "Number of paid items per month in 2025",
    x = "Month",
    y = "Number of prescription items"
  ) +
  facet_wrap(~ HBT, scales = "free_y") +
  theme(
    strip.text = element_text(face = "bold", size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Figure two presents monthly carbamazepine items for each health board in a grid of small plots. There is a wide range in absolute prescribing volume between boards, with some boards consistently issuing many more items than others. This pattern is likely to reflect differences in population size and case mix, although these factors are not directly adjusted for in this descriptive analysis. Within individual boards the month to month pattern is broadly similar to the national picture, with lower volumes at the start of the year and higher volumes later in the period.

## Carbamazepine prescribing and deprivation

```{r}
if (!is.null(carb_board_month_simd)) {

  simd_scatter <- carb_board_month_simd %>%
    dplyr::group_by(HBT, HBname, prop_q1_most_deprived, board_population) %>%
    dplyr::summarise(
      mean_items = mean(total_items, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::mutate(
      mean_items_per_1000 = mean_items / (board_population / 1000)
    )

  ggplot(simd_scatter,
         aes(x = prop_q1_most_deprived,
             y = mean_items_per_1000,
             label = HBname)) +
    geom_point(size = 3) +
    geom_text(vjust = -0.5, size = 3) +
    scale_x_continuous(labels = percent_format(accuracy = 1)) +
    scale_y_continuous(labels = label_comma()) +
    labs(
      title = "Carbamazepine prescribing and deprivation by health board",
      subtitle = "Mean monthly items per 1,000 population versus share of most deprived SIMD data zones",
      x = "Share of data zones in most deprived SIMD quintile",
      y = "Mean monthly carbamazepine items per 1,000 population"
    )
}
```

Figure three compares the mean number of carbamazepine items per month per thousand population with the share of data zones in the most deprived SIMD quintile in each health board. Any pattern should be interpreted cautiously, but it gives an initial view of how prescribing volume relates to area deprivation and moves the analysis closer to an inequality question.

# Top boards and cost per item

```{r}
top_boards <- carb_board_month %>%
  dplyr::group_by(HBT) %>%
  dplyr::summarise(
    mean_items = mean(total_items, na.rm = TRUE),
    mean_cost  = mean(total_cost,  na.rm = TRUE),
    cost_per_item = mean_cost / mean_items,
    .groups = "drop"
  ) %>%
  dplyr::arrange(dplyr::desc(mean_items)) %>%
  dplyr::slice_head(n = 10)

top_boards %>%
  dplyr::mutate(
    mean_items    = round(mean_items),
    mean_cost     = round(mean_cost, 2),
    cost_per_item = round(cost_per_item, 2)
  ) %>%
  knitr::kable(
    caption = "Top ten NHS boards for carbamazepine prescribing in 2025, average monthly items and costs",
    digits = 2
  )
```

Table one summarises the ten health boards with the highest average monthly number of carbamazepine items. For each board the table shows the mean number of items, mean gross ingredient cost and average cost per item over the study period. The results confirm that a small number of boards account for a large share of national volume, while the average cost per item is more tightly grouped. Small differences in cost per item may reflect local choices of formulation, strength or brand, but overall the figures suggest fairly consistent use of generic carbamazepine products across boards.

# Discussion

This descriptive analysis provides an overview of carbamazepine use in NHS Scotland using routine Community Prescriptions data. Over the first seven months of the year, the volume of carbamazepine items appears to be stable at the national level, with only slight monthly fluctuations. This is consistent with what is expected for a medication that is primarily used for long-term maintenance. Absolute volume varies significantly between boards, which is to be expected given that prescribing reflects both clinical practice and the size and composition of local populations.

By linking prescribing data to SIMD based measures it becomes possible to examine how carbamazepine prescribing is distributed across more and less deprived areas. The scatter plot relates mean items per thousand population to the share of data zones in the most deprived quintile for each board. This gives a first view of how deprivation and prescribing volume might be associated. Any pattern should be interpreted with care, because the analysis uses simple summaries and does not include formal modelling, but it shows that the data can support inequality focused questions.

There are several important limitations. The analysis covers only a short time window, so it cannot describe longer term trends or the impact of changes in clinical guidelines. Outcomes are counts of items and costs rather than fully adjusted rates, so differences between boards cannot be interpreted directly as differences in prescribing relative to clinical need. The data are at item level and do not include information on individual patients, indications or outcomes, so it is not possible to assess appropriateness of treatment or seizure control. From a data science perspective the work could be extended by automating the download of additional months or additional drugs through a separate script and by adding more flexible visual forms, such as practice level histograms, once appropriate data are available.

# Conclusion

This report explains how carbamazepine use in the community varies over time and between health boards in Scotland using prescribing data from Public Health Scotland. While absolute prescribing levels clearly vary between boards, national volumes are generally stable over the period under study. Additionally, the work demonstrates that prescribing data can be summarised at the board level and connected to SIMD data. Stronger evaluations of inequality and quality in epilepsy treatment throughout Scotland could be supported by the same pipeline with more time points, population denominators, and demographic information.

# References

Maan, J.S., Duong, T.v.H. and Saadabadi, A. (2023) Carbamazepine. In: StatPearls [Internet]. Treasure Island (FL): StatPearls Publishing. Available at: https://www.ncbi.nlm.nih.gov/books/NBK482455/ (Accessed: 27 November 2025).

Public Health Scotland, Epilepsy: key points. (n.d.). Available at: https://www.scotpho.org.uk/health-conditions/epilepsy/introduction/ (Accessed: 27 November 2025).

Scottish Government (n.d.) Scottish Index of Multiple Deprivation 2020. Available at: https://www.gov.scot/collections/scottish-index-of-multiple-deprivation-2020/ (Accessed: 27 November 2025).