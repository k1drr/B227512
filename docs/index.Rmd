---
title: "Assessment"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

library(tidyverse)
library(lubridate)
library(scales)
library(knitr)
library(readxl)

theme_set(theme_minimal(base_size = 14))
```

# Introduction

Epilepsy is a common long term neurological condition in Scotland and it can have a major impact on daily life. It is linked to unplanned hospital use, loss of independence and higher risk of early death (Public Health Scotland). Effective and fair access to treatment is therefore an important public health goal.

Carbamazepine is an older antiepileptic medicine that is still widely used. It is prescribed mainly in primary care to control seizures and is also used for some forms of nerve pain.(Maan JS, Duong TvH and Saadabadi A., 2023) Because most prescriptions are written in the community, national prescribing data provide a practical way to describe how much carbamazepine is used and how this varies across Scotland.

In this report I use Public Health Scotland Prescriptions in the Community data to describe recent carbamazepine prescribing in NHS Scotland. The main question is how the number of carbamazepine prescription items changes by month and how prescribing volume differs between health boards. I also set up the data so that it can be linked to the Scottish Index of Multiple Deprivation for future work on inequality (Scottish Government SIMD 2020). I expect national volumes to be fairly stable over time, with higher absolute counts in larger boards and a possible association between higher deprivation and higher prescribing volume.

# Data and methods

The analysis uses open prescribing data from Public Health Scotland that cover all NHS prescriptions dispensed in the community in Scotland. I selected the board level files for the first seven months of the year and combined them into one dataset. A date variable was created from the payment month and the data were restricted to rows where the British National Formulary item description contains the word carbamazepine. This captures generic and branded forms of the drug that are commonly used for epilepsy and related conditions.

For each month I summed the number of paid items and the gross ingredient cost across Scotland and then for each health board. This produced one table with national totals by month and one table with health board totals by month. All wrangling and summaries were carried out in R using tidyverse and lubridate. The steps are written as one pipeline that could be run from a separate script, which supports reproducibility and would allow the data preparation to be automated before knitting the report.

To prepare for inequality analysis I also used the SIMD twenty twenty data zone lookup. Data zones were grouped to health board level and I calculated the proportion of zones in the most deprived and least deprived national quintiles for each board. This summary was joined to the carbamazepine prescribing table using the health board code so that each board month record has basic deprivation information attached. In this report that deprivation information is mainly used to enrich the dataset so that future work on inequality can build on it.

# Board level files for early 2025

```{r}
urls <- c(
  "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f02161c1-15f6-4d9f-8be5-01ba613d4303/download/hb_pitc2025_07.csv",
  "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9de908b3-9c28-4cc3-aa32-72350a0579d1/download/hb_pitc2025_01_06.csv"
)

presc_raw <- urls %>%
  map_dfr(readr::read_csv)

# Check column names
names(presc_raw)

# Add proper date from PaidDateMonth
presc <- presc_raw %>%
  mutate(
    date = ymd(paste0(PaidDateMonth, "01"))
  )

# Filter to carbamazepine items
carb_all <- presc %>%
  filter(str_detect(
    BNFItemDescription,
    regex("carbamazepine", ignore_case = TRUE)
  ))

# Scotland total by month
carb_scot_month <- carb_all %>%
  group_by(date) %>%
  summarise(
    total_items = sum(NumberOfPaidItems, na.rm = TRUE),
    total_cost  = sum(GrossIngredientCost, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(date)

# Board level by month using HBT as board code
carb_board_month <- carb_all %>%
  group_by(date, HBT) %>%
  summarise(
    total_items = sum(NumberOfPaidItems, na.rm = TRUE),
    total_cost  = sum(GrossIngredientCost, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
# Read SIMD from the CSV version of the data zone lookup

simd_path <- "data_raw/SIMD2020v2_datazone_lookup.csv"

if (file.exists(simd_path)) {

  simd_dz <- readr::read_csv(simd_path, show_col_types = FALSE)

  # Health board level SIMD and population summary
  simd_board <- simd_dz %>%
    dplyr::group_by(HBcode, HBname) %>%
    dplyr::summarise(
      n_datazones = dplyr::n(),
      prop_q1_most_deprived  = mean(SIMD2020v2_Quintile == 1, na.rm = TRUE),
      prop_q5_least_deprived = mean(SIMD2020v2_Quintile == 5, na.rm = TRUE),
      board_population       = sum(Population, na.rm = TRUE),
      .groups = "drop"
    )

  # Join SIMD summary to prescribing using board code
  carb_board_month_simd <- carb_board_month %>%
    dplyr::left_join(simd_board, by = c("HBT" = "HBcode"))

} else {
  carb_board_month_simd <- NULL
}
```

# Results

## Scotland level prescribing

```{r}
# Add a reference line at the mean monthly volume to help interpret variation
mean_scot_items <- mean(carb_scot_month$total_items, na.rm = TRUE)

ggplot(carb_scot_month, aes(x = date, y = total_items)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  geom_smooth(
    method = "loess",
    se = FALSE,
    linewidth = 0.7,
    linetype = "dashed"
  ) +
  geom_hline(
    yintercept = mean_scot_items,
    linetype = "dotted"
  ) +
  scale_x_date(
    date_labels = "%b",
    breaks = unique(carb_scot_month$date)
  ) +
  scale_y_continuous(labels = label_comma()) +
  labs(
    title = "Monthly carbamazepine prescriptions in Scotland",
    subtitle = "Number of paid items in community prescribing 2025",
    x = "Month",
    y = "Number of prescription items"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Figure one shows the total number of carbamazepine items dispensed in the community in Scotland for each month in the first part of the year. Overall the national level is fairly stable, with values in a narrow band rather than a clear upward or downward trend. There is a dip at the start of the year, followed by a gradual rise towards mid year. This pattern is consistent with normal variation in prescribing for a medicine that is mainly used in long term treatment.

# Differences between health boards

```{r}
carb_board_summary <- carb_board_month %>%
  group_by(HBT) %>%
  mutate(
    mean_items = mean(total_items, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    HBT = forcats::fct_reorder(HBT, mean_items, .desc = TRUE)
  )

ggplot(carb_board_summary,
       aes(x = date, y = total_items, group = HBT)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 0.8) +
  scale_x_date(date_labels = "%b") +
  scale_y_continuous(labels = label_comma()) +
  labs(
    title = "Carbamazepine prescribing by NHS board",
    subtitle = "Number of paid items per month in 2025",
    x = "Month",
    y = "Number of prescription items"
  ) +
  facet_wrap(~ HBT, scales = "free_y") +
  theme(
    strip.text = element_text(face = "bold", size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Figure two presents monthly carbamazepine items for each health board in a grid of small plots. There is a wide range in absolute prescribing volume between boards, with some boards consistently issuing many more items than others. This pattern is likely to reflect differences in population size and case mix, although these factors are not directly adjusted for in this descriptive analysis. Within individual boards the month to month pattern is broadly similar to the national picture, with lower volumes at the start of the year and higher volumes later in the period.

## Carbamazepine prescribing and deprivation

```{r}
if (!is.null(carb_board_month_simd)) {

  simd_scatter <- carb_board_month_simd %>%
    dplyr::group_by(HBT, HBname, prop_q1_most_deprived, board_population) %>%
    dplyr::summarise(
      mean_items = mean(total_items, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::mutate(
      mean_items_per_1000 = mean_items / (board_population / 1000)
    )

  ggplot(simd_scatter,
         aes(x = prop_q1_most_deprived,
             y = mean_items_per_1000,
             label = HBname)) +
    geom_point(size = 3) +
    geom_text(vjust = -0.5, size = 3) +
    scale_x_continuous(labels = percent_format(accuracy = 1)) +
    scale_y_continuous(labels = label_comma()) +
    labs(
      title = "Carbamazepine prescribing and deprivation by health board",
      subtitle = "Mean monthly items per 1,000 population versus share of most deprived SIMD data zones",
      x = "Share of data zones in most deprived SIMD quintile",
      y = "Mean monthly carbamazepine items per 1,000 population"
    )
}
```

Figure three compares the mean number of carbamazepine items per month per thousand population with the share of data zones in the most deprived SIMD quintile in each health board. Any pattern should be interpreted cautiously, but it gives an initial view of how prescribing volume relates to area deprivation and moves the analysis closer to an inequality question.

# Top boards and cost per item

```{r}
top_boards <- carb_board_month %>%
  dplyr::group_by(HBT) %>%
  dplyr::summarise(
    mean_items = mean(total_items, na.rm = TRUE),
    mean_cost  = mean(total_cost,  na.rm = TRUE),
    cost_per_item = mean_cost / mean_items,
    .groups = "drop"
  ) %>%
  dplyr::arrange(dplyr::desc(mean_items)) %>%
  dplyr::slice_head(n = 10)

top_boards %>%
  dplyr::mutate(
    mean_items    = round(mean_items),
    mean_cost     = round(mean_cost, 2),
    cost_per_item = round(cost_per_item, 2)
  ) %>%
  knitr::kable(
    caption = "Top ten NHS boards for carbamazepine prescribing in 2025, average monthly items and costs",
    digits = 2
  )
```

Table one summarises the ten health boards with the highest average monthly number of carbamazepine items. For each board the table shows the mean number of items, mean gross ingredient cost and average cost per item over the study period. The results confirm that a small number of boards account for a large share of national volume, while the average cost per item is more tightly grouped. Small differences in cost per item may reflect local choices of formulation, strength or brand, but overall the figures suggest fairly consistent use of generic carbamazepine products across boards.

# Discussion

This descriptive analysis uses routine Community Prescriptions data to give an overview of carbamazepine use in NHS Scotland. At national level the volume of carbamazepine items appears stable over the first seven months of the year, with only modest month to month fluctuation. This matches the expectation for a medicine used mainly in long term maintenance treatment. Between boards there is substantial variation in absolute volume, which is also expected because prescribing reflects the size and structure of local populations as well as clinical practice.

By linking prescribing data to SIMD based measures it becomes possible to examine how carbamazepine prescribing is distributed across more and less deprived areas. The scatter plot relates mean items per thousand population to the share of data zones in the most deprived quintile for each board. This gives a first view of how deprivation and prescribing volume might be associated. Any pattern should be interpreted with care, because the analysis uses simple summaries and does not include formal modelling, but it shows that the data can support inequality focused questions.

There are several important limitations. The analysis covers only a short time window, so it cannot describe longer term trends or the impact of changes in clinical guidelines. Outcomes are counts of items and costs rather than fully adjusted rates, so differences between boards cannot be interpreted directly as differences in prescribing relative to clinical need. The data are at item level and do not include information on individual patients, indications or outcomes, so it is not possible to assess appropriateness of treatment or seizure control. From a data science perspective the work could be extended by automating the download of additional months or additional drugs through a separate script and by adding more flexible visual forms, such as practice level histograms, once appropriate data are available.

# Conclusion

Using Public Health Scotland prescribing data, this report describes how carbamazepine use in the community varies over time and between health boards in Scotland. National volumes are broadly stable over the period studied, while absolute prescribing levels differ clearly between boards. The work also shows that prescribing data can be linked to SIMD information and summarised at board level. With additional time points, population denominators and demographic detail, the same pipeline could support stronger assessments of inequality and quality in epilepsy treatment across Scotland.

# References

Maan, J.S., Duong, T.v.H. and Saadabadi, A. (2023) Carbamazepine. In: StatPearls [Internet]. Treasure Island (FL): StatPearls Publishing. Available at: https://www.ncbi.nlm.nih.gov/books/NBK482455/ (Accessed: 27 November 2025).

Public Health Scotland, Epilepsy: key points. (n.d.). Available at: https://www.scotpho.org.uk/health-conditions/epilepsy/introduction/ (Accessed: 27 November 2025).

Scottish Government (n.d.) Scottish Index of Multiple Deprivation 2020. Available at: https://www.gov.scot/collections/scottish-index-of-multiple-deprivation-2020/ (Accessed: 27 November 2025).